# This docker-compose.yml demonstrates the advanced Gateway-Stack.
# It includes the VPN-Gateway, a WireGuard-Server (wg-easy)
# on the same macvlan, and consumer services (AdGuard, Proxies)
# that use the gateway's network.

version: "3.9"

services:
  # -----------------------------------------------------------------
  #  1. The VPN Gateway (The heart of the stack)
  # -----------------------------------------------------------------
  vpn:
    image: boingbasti/nordvpn-gateway:latest # Use your own image name
    container_name: nordvpn-gateway
    networks:
      macvlan_net:
        # Assign a static IP from your LAN (must be free)
        ipv4_address: 192.168.1.100
    # Give the container enough time to clean up iptables and disconnect
    stop_grace_period: 45s
    cap_add:
      - NET_ADMIN # Required for all networking rules, killswitch, etc.
      - NET_RAW   # Required for 'VPN_AUTO_CONNECT=best' pings
    devices:
      - /dev/net/tun
    environment:
      # --- WireGuard Bypass Settings (Example) ---
      - WIREGUARD_BYPASS=on
      - WIREGUARD_SERVER_IP=192.168.1.200 # IP of the wg-easy container
      - WIREGUARD_SUBNET=10.100.100.0/24 # Subnet of your WG clients
      
      # --- Allow LAN and WG clients to use the VPN ---
      - ALLOWLIST_SUBNET=192.168.1.0/24,10.100.100.0/24
      
      # --- Connection & Performance ---
      - VPN_COUNTRY=Germany
      - VPN_AUTO_CONNECT=best
      - VPN_MTU=auto
      - VPN_TECHNOLOGY=NordLynx
      - KILLSWITCH=on

      # --- Maintenance & Resilience ---
      - VPN_REFRESH=1440 # Reconnect once every 24 hours (1440 minutes)
      - LOG_STATUS_INTERVAL=60 # Log status every hour
      - DEBUG=off
    volumes:
      # Mount your token as a Docker Secret
      - ./nordvpn_token.txt:/run/secrets/nordvpn_token:ro
      # Sync timezone with the host
      - /etc/localtime:/etc/localtime:ro
    sysctls:
      # --- CRITICAL ---
      - net.ipv4.ip_forward=1 # Allows the container to act as a gateway
      # --- Recommended ---
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.default.disable_ipv6=1
    restart: unless-stopped

  # -----------------------------------------------------------------
  #  2. WireGuard Server (wg-easy)
  # -----------------------------------------------------------------
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wireguard-easy
    networks:
      macvlan_net:
        # Assign a static IP from your LAN (must be free)
        ipv4_address: 192.168.1.200
    depends_on:
      - vpn
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      # Mount a persistent volume for wg-easy's config
      - ./data/wg-easy-config:/etc/wireguard
    environment:
      # --- Modern wg-easy ---
      # Initial setup (Host, DNS, Password, etc.)
      # is now done via the Web UI on first run.
      - DISABLE_IPV6=true
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.default.disable_ipv6=1
      - net.ipv6.conf.lo.disable_ipv6=1
    restart: unless-stopped

  # -----------------------------------------------------------------
  #  3. AdGuard Home (Consumer Service)
  # -----------------------------------------------------------------
  adguardhome:
    container_name: adguard-home
    image: adguard/adguardhome:latest
    depends_on: [vpn]
    # --- CRITICAL ---
    # Attach to the vpn container's network stack
    network_mode: "service:vpn"
    volumes:
      - ./data/adguard-work:/opt/adguardhome/work
      - ./data/adguard-config:/opt/adguardhome/conf
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nslookup", "google.com", "1.1.1.1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 2m

  # -----------------------------------------------------------------
  #  4. SOCKS5 Proxy (Consumer Service)
  # -----------------------------------------------------------------
  socks5:
    image: boingbasti/nordvpn-socks5:latest # Use your own image name
    container_name: vpn-socks5-proxy
    depends_on: [vpn]
    # --- CRITICAL ---
    network_mode: "service:vpn"
    environment:
      - PROXY_PORT=1080
      - ALLOWED_IPS="192.168.1.0/24,127.0.0.1/32"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsSL", "--max-time", "5", "-x", "socks5h://localhost:1080", "https://1.1.1.1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 1m

  # -----------------------------------------------------------------
  #  5. HTTP Proxy (Consumer Service)
  # -----------------------------------------------------------------
  http-proxy:
    image: boingbasti/nordvpn-privoxy:latest # Use your own image name
    container_name: vpn-http-proxy
    depends_on: [vpn]
    # --- CRITICAL ---
    network_mode: "service:vpn"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsSL", "--max-time", "5", "-x", "http://localhost:8118", "https://1.1.1.1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 1m

# -----------------------------------------------------------------
#  Network Definition
# -----------------------------------------------------------------
networks:
  macvlan_net:
    # This network must be created *before* starting the stack:
    # docker network create -d macvlan \
    #   --subnet=192.168.1.0/24 \
    #   --gateway=192.168.1.1 \
    #   -o parent=eth0 \
    #   macvlan_net
    external: true
    name: macvlan_net # Must match the name you created
